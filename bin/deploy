#!/usr/bin/env bash

if [[ -n $RAILS_ENV && $RAILS_ENV != "development" ]]; then
  echo "Refusing to run in $RAILS_ENV environment."
  exit 1
fi

stash_name="deploy-autostash"
git stash push --include-untracked -m "$stash_name"

if [ -f "bin/rails" ]; then
  bundle exec rails zeitwerk:check || exit 1
fi

git push &&
  git switch deploy &&
  git reset --hard main &&
  git push --force || exit 1

if [[ -f ".github/workflows/deploy.yml" ]]; then
  gh workflow run deploy
fi

git checkout main || exit 1

if git stash list | head -1 | grep -q "$stash_name"; then
  git stash pop
fi
